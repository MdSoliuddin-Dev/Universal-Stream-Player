<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Universal Stream Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0b0f14;--card:#0f1722cc;--card-border:#1f2a3b;--accent:#6bb2ff;--accent-2:#8a5cff;
      --text:#e6edf3;--muted:#9fb0c3;--danger:#ff6b6b;--ok:#26d07c;
      --ring:0 0 0 2px color-mix(in oklab,var(--accent) 40%,transparent)
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);
      background:
        radial-gradient(1200px 1200px at 10% -10%,color-mix(in oklab,var(--accent) 20%,transparent),transparent 55%),
        radial-gradient(1000px 1000px at 110% 10%,color-mix(in oklab,var(--accent-2) 25%,transparent),transparent 50%),
        var(--bg);
      padding:24px;display:grid;place-items:start center
    }
    .wrap{width:min(1100px,100%);display:grid;gap:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{margin:0;font-weight:700;letter-spacing:.2px;font-size:clamp(18px,3vw,22px);display:flex;align-items:center;gap:10px}
    .badge{font-size:12px;color:var(--muted);border:1px solid var(--card-border);padding:4px 8px;border-radius:999px;background:linear-gradient(180deg,#11182799,#0b1220aa)}
    .controls{
      display:grid;grid-template-columns:1fr auto auto auto auto auto auto;gap:8px;padding:12px;border:1px solid var(--card-border);
      background:linear-gradient(180deg,#0b121caa,#0b121c66);backdrop-filter:blur(8px);border-radius:14px
    }
    .url-input{display:flex;gap:8px;align-items:center}
    .url-input input[type="text"]{
      flex:1 1 auto;min-width:160px;padding:12px 14px;border-radius:12px;border:1px solid var(--card-border);background:#0f1624cc;color:var(--text);
      outline:none;transition:border-color .2s,box-shadow .2s
    }
    .url-input input[type="text"]:focus{border-color:var(--accent);box-shadow:var(--ring)}
    .btn{
      appearance:none;border:1px solid var(--card-border);background:linear-gradient(180deg,#152035,#0f1729);color:var(--text);
      padding:10px 14px;border-radius:12px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-weight:600;
      transition:transform .06s ease,border-color .2s,background .2s,box-shadow .2s;user-select:none;-webkit-tap-highlight-color:transparent;
      position:relative;overflow:hidden
    }
    .btn:hover{border-color:color-mix(in oklab,var(--accent) 40%,var(--card-border));box-shadow:0 6px 18px #0005}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(180deg,color-mix(in oklab,var(--accent) 30%,#152035),#0f1729);border-color:color-mix(in oklab,var(--accent) 50%,var(--card-border))}
    .btn.good{border-color:color-mix(in oklab,var(--ok) 50%,var(--card-border))}
    .btn.warn{border-color:color-mix(in oklab,var(--danger) 50%,var(--card-border))}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .select,.range{
      appearance:none;border:1px solid var(--card-border);background:#0f1624cc;color:var(--text);padding:10px 12px;border-radius:12px;font-weight:600
    }
    .flags{display:flex;align-items:center;gap:14px;padding:0 12px 12px;color:var(--muted);font-size:13px}
    .flags label{display:inline-flex;align-items:center;gap:8px;cursor:pointer}
    .flags input[type="checkbox"]{width:16px;height:16px;accent-color:color-mix(in oklab,var(--accent) 60%,white)}
    .player-card{border:1px solid var(--card-border);border-radius:16px;background:linear-gradient(180deg,#0b121cdd,#0a111b99);overflow:hidden;box-shadow:0 10px 24px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.02)}
    .stage{width:100%;aspect-ratio:16/9;background:#000;position:relative;display:grid;place-items:center}
    .stage.theater{aspect-ratio:21/9}
    video,iframe{width:100%;height:100%;border:0;display:none;background:#000;object-fit:contain}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;padding:12px;border-top:1px solid var(--card-border);background:linear-gradient(180deg,#0e1524,#0a1220)}
    .hint{color:var(--muted);font-size:12px;margin:2px 4px 0}
    .fab{
      position:absolute;top:12px;right:12px;width:44px;height:44px;border-radius:50%;
      display:grid;place-items:center;background:linear-gradient(180deg,#1a2640,#0f1729);border:1px solid var(--card-border);color:var(--text);
      box-shadow:0 10px 24px #0008,0 0 0 0 rgba(107,178,255,.3);animation:fabease .8s ease .4s both, breathe 2.6s ease-in-out infinite;
      cursor:pointer;opacity:.98
    }
    .fab:hover{box-shadow:0 10px 24px #000a,0 0 0 6px rgba(107,178,255,.12)}
    .fab.good{border-color:color-mix(in oklab,var(--ok) 60%,var(--card-border));}
    @keyframes fabease{from{transform:translateY(-8px);opacity:0}to{transform:translateY(0);opacity:1}}
    @keyframes breathe{0%,100%{transform:translateY(0)}50%{transform:translateY(-1px)}}
    @media (max-width: 820px){
      body{padding:16px}
      .controls{grid-template-columns:1fr 1fr;grid-auto-rows:auto}
      .url-input{grid-column:1 / -1}
      .toolbar{padding:10px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M3 5a2 2 0 0 1 2-2h6.5a2 2 0 0 1 1.6.8l2.2 2.9A2 2 0 0 0 17.9 8H19a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5Z" stroke="#8ab4ff" stroke-width="1.3"/>
          <path d="M10 3v3a2 2 0 0 0 2 2h3" stroke="#8a5cff" stroke-width="1.3"/>
        </svg>
        Universal Stream Player
      </h1>
      <span class="badge">HLS · DASH · MP4 · Embed</span>
    </header>

    <div class="controls">
      <div class="url-input">
        <input id="urlInput" type="text" inputmode="url" placeholder="Paste .m3u8, .mpd, MP4/WebM URL, or YouTube share link / embed code" />
        <button id="loadBtn" class="btn primary">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Load
        </button>
      </div>

      <select id="qualitySel" class="select" title="Quality">
        <option value="auto">Quality: Auto</option>
      </select>

      <select id="speedSel" class="select" title="Speed">
        <option value="0.5">0.5×</option>
        <option value="0.75">0.75×</option>
        <option value="1" selected>1×</option>
        <option value="1.25">1.25×</option>
        <option value="1.5">1.5×</option>
        <option value="2">2×</option>
      </select>

      <label class="btn" title="Volume">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 10v4h3l4 3V7l-4 3H4z" stroke="currentColor" stroke-width="1.3" fill="currentColor"/></svg>
        <input id="volume" class="range" type="range" min="0" max="1" step="0.01" value="1" style="width:120px" />
      </label>

      <button id="theaterBtn" class="btn" title="Theater mode">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 7h16v10H4z" stroke="currentColor" stroke-width="1.4"/><path d="M8 7v10M16 7v10" stroke="currentColor" stroke-width="1.2" opacity=".6"/></svg>
        Theater
      </button>

      <button id="pipBtn" class="btn" title="Picture-in-Picture">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <rect x="3" y="4" width="18" height="14" rx="2" stroke="currentColor" stroke-width="1.4"/>
          <rect x="12.5" y="9.5" width="7" height="5.5" rx="1" fill="currentColor"/>
        </svg>
        PiP
      </button>

      <button id="fsBtn" class="btn" title="Fullscreen">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M8 4H4v4M20 8V4h-4M4 16v4h4M20 16v4h-4" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Fullscreen
      </button>

      <button id="stopBtn" class="btn warn" title="Stop/Reset">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <rect x="6" y="6" width="12" height="12" rx="2" stroke="currentColor" stroke-width="1.4"/>
        </svg>
        Stop
      </button>
    </div>

    <div class="flags">
      <label><input type="checkbox" id="autoplay" checked /> Autoplay (muted)</label>
      <label><input type="checkbox" id="loop" /> Loop</label>
      <span class="hint">Tip: YouTube share links are auto‑embedded; HLS = .m3u8, DASH = .mpd. </span>
    </div>

    <div class="player-card">
      <div class="stage" id="playerShell">
        <video id="video" controls playsinline muted crossorigin="anonymous" poster="" preload="metadata"></video>
        <iframe id="frame" allow="autoplay; fullscreen; picture-in-picture; web-share; encrypted-media" referrerpolicy="no-referrer"></iframe>

        <button id="pipFab" class="fab" title="Picture-in-Picture (floating)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <rect x="3" y="4" width="18" height="14" rx="2" stroke="currentColor" stroke-width="1.4"/>
            <rect x="12.5" y="9.5" width="7" height="5.5" rx="1" fill="currentColor"/>
          </svg>
        </button>
      </div>
      <div class="toolbar hint">
        • YouTube share links supported, plus HLS/DASH/MP4, PiP, Quality, Speed, Volume, Theater, and Fullscreen. 
      </div>
    </div>
  </div>

  <script src="hls.min.js"></script>
  <script src="dash.all.min.js"></script>
  <script>
    const input = document.getElementById('urlInput');
    const loadBtn = document.getElementById('loadBtn');
    const video = document.getElementById('video');
    const frame = document.getElementById('frame');
    const autoplayEl = document.getElementById('autoplay');
    const loopEl = document.getElementById('loop');

    const pipBtn = document.getElementById('pipBtn');
    const pipFab = document.getElementById('pipFab');
    const fsBtn = document.getElementById('fsBtn');
    const stopBtn = document.getElementById('stopBtn');
    const theaterBtn = document.getElementById('theaterBtn');

    const qualitySel = document.getElementById('qualitySel');
    const speedSel = document.getElementById('speedSel');
    const volumeRange = document.getElementById('volume');

    const shell = document.getElementById('playerShell');

    let hlsPlayer = null;
    let dashPlayer = null;

    // --- YouTube share link handling ---
    function parseYouTubeTimeToSeconds(t) {
      if (!t) return 0;
      if (/^\d+$/.test(t)) return parseInt(t, 10);
      const m = String(t).match(/(?:(\d+)h)?(?:(\d+)m)?(?:(\d+)s)?/i);
      if (m) {
        const h = parseInt(m[25] || '0', 10);
        const mnt = parseInt(m[26] || '0', 10);
        const s = parseInt(m[27] || '0', 10);
        return (h*3600) + (mnt*60) + s;
      }
      if (/^\d+s$/i.test(t)) return parseInt(t, 10);
      return 0;
    }

    function isYouTubeUrl(u) {
      try {
        const url = new URL(u);
        const host = url.hostname.replace(/^www\./,'');
        return ['youtube.com', 'youtu.be', 'youtube-nocookie.com'].some(h => host.endsWith(h));
      } catch { return false; }
    }

    function toYouTubeEmbed(u) {
      try {
        const url = new URL(u);
        const host = url.hostname.replace(/^www\./,'');
        const params = url.searchParams;
        const start = parseYouTubeTimeToSeconds(params.get('start') || params.get('t'));
        let embedBase = 'https://www.youtube-nocookie.com/embed/'; // privacy-enhanced
        // watch?v=ID
        if (host.endsWith('youtube.com') && url.pathname === '/watch') {
          const id = params.get('v');
          if (!id) return null;
          return embedBase + id + (start ? ('?start=' + start) : '');
        }
        // youtu.be/ID
        if (host.endsWith('youtu.be')) {
          const id = url.pathname.replace(/^\//,'');
          if (!id) return null;
          return embedBase + id + (start ? ('?start=' + start) : '');
        }
        // shorts/ID -> embed/ID
        if (host.endsWith('youtube.com') && /^\/shorts\/[^/]+/i.test(url.pathname)) {
          const id = url.pathname.split('/')[26];
          if (!id) return null;
          return embedBase + id + (start ? ('?start=' + start) : '');
        }
        // playlist -> videoseries
        if (host.endsWith('youtube.com') && url.pathname === '/playlist') {
          const list = params.get('list');
          if (!list) return null;
          return embedBase + 'videoseries?list=' + encodeURIComponent(list);
        }
        // already embed
        if ((host.endsWith('youtube.com') || host.endsWith('youtube-nocookie.com')) && url.pathname.startsWith('/embed/')) {
          return url.toString();
        }
        return null;
      } catch { return null; }
    }
    // --- end YouTube handling ---

    function isHls(url){ return /\.m3u8(\?|#|$)/i.test(url) }
    function isDash(url){ return /\.mpd(\?|#|$)/i.test(url) }
    function looksLikeEmbedCode(text){ return /<\s*iframe[\s\S]*<\/\s*iframe\s*>/i.test(text) }
    function looksLikeEmbedUrl(url){
      return /(youtube\.com\/embed|youtube-nocookie\.com\/embed|player\.vimeo\.com\/video|dailymotion\.com\/embed)/i.test(url)
    }

    function clearQualityOptions(){
      qualitySel.innerHTML = '<option value="auto">Quality: Auto</option>';
    }
    function labelForHlsLevel(l){
      if (!l) return '';
      if (l.height) return l.height + 'p';
      if (l.bitrate) return Math.round(l.bitrate/1000) + ' kbps';
      return 'Level';
    }

    function teardown(){
      if (hlsPlayer){ hlsPlayer.destroy(); hlsPlayer = null; }
      if (dashPlayer){ try{ dashPlayer.reset(); }catch{} dashPlayer = null; }
      video.pause();
      video.removeAttribute('src');
      video.load();
      video.style.display = 'none';
      frame.src = 'about:blank';
      frame.style.display = 'none';
      disablePipIfNeeded();
      setMediaMetadata(null);
      clearQualityOptions();
    }

    async function tryAutoplay(){
      if (!autoplayEl.checked) return;
      try{ video.muted = true; await video.play(); }catch{}
    }

    function enableVideoUI(){
      video.loop = !!loopEl.checked;
      video.style.display = 'block';
      frame.style.display = 'none';
      disablePipIfNeeded();
    }
    function enableFrameUI(url){
      frame.src = url;
      frame.style.display = 'block';
      video.style.display = 'none';
      disablePipIfNeeded();
    }

    function disablePipIfNeeded(){
      const pipSupported = document.pictureInPictureEnabled && !video.disablePictureInPicture;
      const onVideo = video.style.display !== 'none';
      const canPip = pipSupported && onVideo;
      pipBtn.disabled = !canPip;
      pipFab.disabled = !canPip;
      pipFab.style.display = canPip ? 'grid' : 'none';
      pipBtn.title = canPip ? 'Picture-in-Picture' : 'PiP not available';
    }

    function fileNameFromUrl(u){
      try{
        const url = new URL(u, location.href);
        return decodeURIComponent(url.pathname.split('/').pop() || url.hostname);
      }catch{ return 'Media'; }
    }

    function setMediaMetadata(src){
      if (!('mediaSession' in navigator)) return;
      if (!src){ navigator.mediaSession.metadata = null; return; }
      const title = fileNameFromUrl(src);
      navigator.mediaSession.metadata = new MediaMetadata({ title, artist: 'Universal Stream Player' });
      navigator.mediaSession.setActionHandler('play', async ()=>{ try{ await video.play(); }catch{} });
      navigator.mediaSession.setActionHandler('pause', ()=> video.pause());
      navigator.mediaSession.setActionHandler('seekbackward', (e)=>{ video.currentTime = Math.max(0, video.currentTime - (e.seekOffset || 10)); });
      navigator.mediaSession.setActionHandler('seekforward', (e)=>{ video.currentTime = Math.min(video.duration || Infinity, video.currentTime + (e.seekOffset || 10)); });
      navigator.mediaSession.setActionHandler('seekto', (e)=>{ if (e.fastSeek && 'fastSeek' in video) video.fastSeek(e.seekTime); else video.currentTime = e.seekTime; });
      const updatePosition = ()=>{
        if ('setPositionState' in navigator.mediaSession && Number.isFinite(video.duration)){
          navigator.mediaSession.setPositionState({ duration: video.duration, playbackRate: video.playbackRate || 1, position: video.currentTime });
        }
        navigator.mediaSession.playbackState = video.paused ? 'paused' : 'playing';
      };
      video.addEventListener('timeupdate', updatePosition);
      video.addEventListener('play', updatePosition);
      video.addEventListener('pause', updatePosition);
      updatePosition();
    }

    async function togglePiP(){
      try{
        if (document.pictureInPictureElement){
          await document.exitPictureInPicture();
        } else if (document.pictureInPictureEnabled && !video.disablePictureInPicture && video.style.display !== 'none'){
          if (video !== document.pictureInPictureElement){
            await video.requestPictureInPicture();
          }
        }
      }catch(e){ console.warn('PiP error:', e); }
    }

    async function toggleFullscreen(){
      try{
        if (!document.fullscreenElement){
          await (shell.requestFullscreen ? shell.requestFullscreen() : video.requestFullscreen());
        } else {
          await document.exitFullscreen();
        }
      }catch(e){ console.warn('Fullscreen error:', e); }
    }

    function populateHlsQualities(){
      clearQualityOptions();
      if (!hlsPlayer || !hlsPlayer.levels || hlsPlayer.levels.length <= 1) return;
      const frag = document.createDocumentFragment();
      hlsPlayer.levels.forEach((lvl, i)=>{
        const opt = document.createElement('option');
        opt.value = String(i);
        opt.textContent = labelForHlsLevel(lvl) || ('Level ' + i);
        frag.appendChild(opt);
      });
      qualitySel.appendChild(frag);
      qualitySel.value = 'auto';
    }

    function populateDashQualities(){
      clearQualityOptions();
      if (!dashPlayer) return;
      const list = dashPlayer.getBitrateInfoListFor('video') || [];
      const frag = document.createDocumentFragment();
      list.forEach((info, i)=>{
        const opt = document.createElement('option');
        opt.value = String(i);
        const h = info.height || info.width ? (info.height ? info.height + 'p' : (info.width + 'w')) : '';
        const kbps = info.bitrate ? Math.round(info.bitrate/1000) + ' kbps' : '';
        opt.textContent = (h || kbps || ('Quality ' + i));
        frag.appendChild(opt);
      });
      qualitySel.appendChild(frag);
      qualitySel.value = 'auto';
    }

    function load(){
      const raw = input.value.trim();
      if (!raw) return;
      teardown();

      // 1) Full iframe code pasted
      if (looksLikeEmbedCode(raw)){
        const container = document.createElement('div');
        container.innerHTML = raw;
        const ifr = container.querySelector('iframe');
        if (ifr) enableFrameUI(ifr.src || '');
        return;
      }

      // 2) YouTube share/link auto-embed
      if (isYouTubeUrl(raw)) {
        const embed = toYouTubeEmbed(raw);
        if (embed) {
          enableFrameUI(embed);
          return;
        }
      }

      const url = raw;

      // 3) Already-embed URL heuristics
      if (looksLikeEmbedUrl(url)){
        enableFrameUI(url);
        return;
      }

      // 4) Stream/file playback
      enableVideoUI();
      setMediaMetadata(url);

      if (isHls(url)){
        if (window.Hls && window.Hls.isSupported()){
          hlsPlayer = new Hls({ enableWorker: true });
          hlsPlayer.loadSource(url);
          hlsPlayer.attachMedia(video);
          hlsPlayer.on(Hls.Events.MANIFEST_PARSED, ()=>{
            populateHlsQualities();
            tryAutoplay();
          });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')){
          video.src = url;
          video.addEventListener('loadedmetadata', tryAutoplay, { once: true });
          clearQualityOptions();
        } else {
          console.warn('HLS not supported in this browser and hls.js is unavailable.');
        }
        return;
      }

      if (isDash(url)){
        if (window.dashjs && window.dashjs.MediaPlayer){
          dashPlayer = dashjs.MediaPlayer().create();
          dashPlayer.initialize(video, url, autoplayEl.checked);
          video.muted = autoplayEl.checked;
          setTimeout(populateDashQualities, 600);
        } else {
          console.warn('dash.js not available.');
        }
        return;
      }

      video.src = url;
      video.addEventListener('loadedmetadata', tryAutoplay, { once: true });
      clearQualityOptions();
    }

    // Wire up UI
    loadBtn.addEventListener('click', () => {
      if (!autoplayEl.checked) video.muted = false;
      load();
    });
    input.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') { if (!autoplayEl.checked) video.muted = false; load(); } });
    stopBtn.addEventListener('click', teardown);
    fsBtn.addEventListener('click', toggleFullscreen);
    pipBtn.addEventListener('click', togglePiP);
    pipFab.addEventListener('click', togglePiP);

    document.addEventListener('fullscreenchange', ()=> fsBtn.classList.toggle('good', !!document.fullscreenElement));
    video.addEventListener('enterpictureinpicture', ()=> { pipBtn.classList.add('good'); pipFab.classList.add('good'); });
    video.addEventListener('leavepictureinpicture', ()=> { pipBtn.classList.remove('good'); pipFab.classList.remove('good'); });
    video.addEventListener('loadeddata', disablePipIfNeeded);
    window.addEventListener('resize', disablePipIfNeeded);

    // Controls
    speedSel.addEventListener('change', ()=>{ video.playbackRate = parseFloat(speedSel.value || '1'); });
    volumeRange.addEventListener('input', ()=>{ video.muted = false; video.volume = parseFloat(volumeRange.value || '1'); });

    theaterBtn.addEventListener('click', ()=>{
      shell.classList.toggle('theater');
      theaterBtn.classList.toggle('good', shell.classList.contains('theater'));
    });

    // Quality selection
    qualitySel.addEventListener('change', ()=>{
      const val = qualitySel.value;
      if (hlsPlayer){
        hlsPlayer.currentLevel = (val === 'auto') ? -1 : parseInt(val, 10);
        return;
      }
      if (dashPlayer){
        if (val === 'auto'){
          dashPlayer.setAutoSwitchQualityFor('video', true);
        } else {
          const idx = parseInt(val, 10);
          dashPlayer.setAutoSwitchQualityFor('video', false);
          dashPlayer.setQualityFor('video', idx);
        }
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e)=>{
      if (['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName)) return;
      if (e.key === ' ') { e.preventDefault(); video.paused ? video.play() : video.pause(); }
      if (e.key.toLowerCase() === 'f') toggleFullscreen();
      if (e.key.toLowerCase() === 'p') togglePiP();
      if (e.key === 'ArrowLeft') video.currentTime = Math.max(0, video.currentTime - 5);
      if (e.key === 'ArrowRight') video.currentTime = Math.min(video.duration || Infinity, video.currentTime + 5);
      if (e.key.toLowerCase() === 't') theaterBtn.click();
    });

    // Init
    disablePipIfNeeded();
  </script>
</body>
</html>
